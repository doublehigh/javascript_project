// jquery.js
let playing = false;
let score;
let trialsLeft;
let step;
let action; // used for setInterval
let fruits = [
    "apple", "banana", "cherries", "grape", "mango",
    "orange", "pear", "pineapple", "peach", "watermelon"
];

$(function () {
    // Ensure the fruit is hidden on initial load
    $("#fruit1").hide();

    // Click on start/reset button
    $("#startreset").click(function () {
        if (playing) {
            // Reload page
            location.reload();
        } else {
            // Start new game
            playing = true;
            score = 0;
            $("#scorevalue").html(score);

            // Show trials left (lives)
            $("#trialsLeft")
                .show()
                .css({
                    display: "flex",
                    "justify-content": "space-evenly",
                    "align-items": "center",
                });

            trialsLeft = 3;
            addHearts();

            // Hide game over box
            $("#gameOver").hide();

            // Change button text
            $("#startreset").html("Reset Game");

            // Start dropping fruits
            startAction();
        }
    });

    // Slice a fruit (works for mouse + touch)
    $("#fruit1").on("mouseover touchstart", function () {
        score++;
        $("#scorevalue").html(score);

        // Play slice sound
        $("#slicesound")[0].play();

        // Stop fruit
        clearInterval(action);

        // Hide fruit with explode effect
        $("#fruit1").hide("explode", 500);

        // Send new fruit after short delay
        setTimeout(startAction, 800);
    });

    // Functions
    function addHearts() {
        $("#trialsLeft").empty();
        for (let i = 0; i < trialsLeft; i++) {
            $("#trialsLeft").append('<div class="heart"></div>');
        }
    }

    function startAction() {
        // Place fruit at the top with a new random fruit
        resetFruit();

        // Move fruit down
        action = setInterval(function () {
            $("#fruit1").css("top", $("#fruit1").position().top + step);

            // Check if fruit is too low
            if ($("#fruit1").position().top > $("#fruitsContainer").height()) {
                if (trialsLeft > 1) {
                    // Lose a life
                    trialsLeft--;
                    addHearts();

                    // Respawn a new fruit
                    resetFruit();
                } else {
                    // Game Over
                    playing = false;
                    $("#startreset").html("Start Game");
                    $("#gameOver")
                        .show()
                        .html(`<p>Game Over!</p><p>Your score is ${score}</p>`);
                    $("#trialsLeft").hide();
                    stopAction();
                }
            }
        }, 10);
    }

    function resetFruit() {
        chooseFruit();
        $("#fruit1").show();

        // Place fruit randomly inside container
        let containerWidth = $("#fruitsContainer").width();
        let fruitWidth = $("#fruit1").width() || 64;
        let leftPos = Math.round((containerWidth - fruitWidth) * Math.random());
        $("#fruit1").css({ left: leftPos, top: -50 });

        // Set step (speed)
        setStep();
    }


    function setStep() {
        if (window.innerWidth < 500) {
            step = 1 + Math.round(2 * Math.random());
        } else {
            step = 1 + Math.round(5 * Math.random());
        }
    }

    function chooseFruit() {
        let randomFruit = fruits[Math.floor(Math.random() * fruits.length)];
        $("#fruit1").attr("src", "images/" + randomFruit + ".png");
    }

    function stopAction() {
        clearInterval(action);
        $("#fruit1").hide();
    }
});
